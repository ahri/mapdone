"use strict";function contractIterate(t,e){var i,n=t,s="Object";"function"==typeof t&&(n=t.prototype,s=t.name||"AnonymousFunc");for(i in n)"function"==typeof n[i]&&"_"!==i.substr(0,1)&&e(i,n,n[i]);return s}function assertAdheresToContract(t,e){var i=[];contractIterate(e,function(t){i.push(t)}),contractIterate(t,function(n){if(-1===i.indexOf(n))throw new Error("'"+e.name+"' does not implement method '"+n+"' from contract '"+t.name+"'")})}function $IsDefined(t){return void 0!==t}function $IsTrueFalseNull(t){return t===!0||t===!1||null===t}function $IsValidName(t){return null!==t.match(/^.../)}function $IsValidUuidV4(t){return null!==t.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i)}function $IsArrayOfUuidV4s(t){for(var e=0;e<t.length;e++)if(!$IsValidUuidV4(t[e]))return!1;return!0}function validateArgsObj(t,e){var i,n={};for(i in t)if(void 0===t[i].default||void 0!==e[i]){if(t[i].required&&(t[i].test=$IsDefined),t[i].test&&t[i].test(e[i])!==!0){if(void 0!==t[i].default){n[i]=t[i].default;continue}throw new Error("Arg '"+i+"' with value '"+e[i]+"' failed test "+t[i].test)}n[i]=e[i]}else n[i]=t[i].default;return n}function EventPubSub(){this._registrations={}}function Node(t){t=validateArgsObj({id:{test:$IsValidUuidV4},name:{test:$IsValidName},todo:{test:$IsTrueFalseNull,"default":!1},description:{"default":""},childIds:{test:$IsArrayOfUuidV4s,"default":[]}},t),this._id=t.id,this._name=t.name,this._todo=t.todo,this._description=t.description,this._childIds=t.childIds}function Mapdone(t,e){this._eventPubSub=t,this._nodeRepository=e}function InMemoryNodeRepository(){this._rootId=null,this._nodes={}}function CommandHandler(){}function CommandExecutor(t,e){this._mapdone=t,this._eventPubSub=e}function LocalNodeRepository(){}function LocalReadModel(){}function nodeConfigEvents(t,e,i,n){i.subscribe("exception",function(t,i,n){var s="Exception event: "+t+'("'+i.join('", "')+'") -> '+n;e.error(s)}),i.subscribe("childAdded",function(e){e==t.node.id&&(t.node=n.getNode(t.node.id))}),i.subscribe("childRemoved",function(e){e==t.node.id&&(t.node=n.getNode(t.node.id))}),i.subscribe("nodeEdited",function(e){var i=t.node.childIds;i.push(t.node.id),-1!==i.indexOf(e)&&(t.node=n.getNode(t.node.id))})}function nodeConfigCommands(t,e,i,n){t.newChild=function(t){var i=e.open({templateUrl:"modal-node.html",controller:"ModalNodeCtrl",resolve:{existingNode:function(){return{}}}});i.result.then(function(e){n.addChild({parentId:t.id,id:uuid.v4(),name:e.name,todo:e.todo,description:e.description})})},t.editNode=function(t){var i=e.open({templateUrl:"modal-node.html",controller:"ModalNodeCtrl",resolve:{existingNode:function(){return t}}});i.result.then(function(e){for(var i={},s=["name","todo","description"],r=0;r<s.length;r++){var o=s[r];t[o]!==e[o]&&(i[o+"From"]=t[o],i[o+"To"]=e[o])}i.id=t.id,n.editNode(i)})},t.attachExisting=function(){i.error("Not yet implemented")},t.addChild=function(){n.addChild({parentId:nodeId,id:uuid.v4(),name:t.newChild.name}),t.newChild.name="",t.newChild.show=!1},t.removeChild=function(t,e){n.removeChild({parentId:t.id,childId:e.id})},t.toggleDone=function(t){n.toggleDone({id:t.id,from:t.todo})}}EventPubSub.prototype.subscribe=function(t,e){void 0===this._registrations[t]&&(this._registrations[t]=[]),this._registrations[t].push(e)},EventPubSub.prototype.publish=function(t,e){if(void 0!==this._registrations[t])for(var i=0;i<this._registrations[t].length;i++)this._registrations[t][i].apply(void 0,e)},Node.prototype.toString=function(){return"Node<"+this._id.substring(0,4)+":"+this._name+">"},Node.prototype.getId=function(){return this._id},Node.prototype.getName=function(){return this._name},Node.prototype.getTodo=function(){return this._todo},Node.prototype.getDescription=function(){return this._description},Node.prototype.getChildIds=function(){return this._childIds},Node.prototype.equals=function(t){return this.getId()===t.getId()&&this.getName()===t.getName()&&this.getTodo()===t.getTodo()&&this.getDescription()===t.getDescription()&&this.getChildIds().join(",")===t.getChildIds().join(",")},Mapdone.prototype.createRoot=function(t){t=validateArgsObj({id:{test:$IsValidUuidV4},name:{required:!0},todo:{"default":null},description:{"default":""}},t);var e=this._nodeRepository.getRootId();if(t.id!==e){if(e)return void this._eventPubSub.publish("rootOverrideError",[t.id,e]);this._nodeRepository.saveNode(new Node(t)),this._nodeRepository.setRootId(t.id),this._eventPubSub.publish("rootCreated",[t.id])}},Mapdone.prototype.addChild=function(t){t=validateArgsObj({parentId:{test:$IsValidUuidV4},id:{test:$IsValidUuidV4},name:{required:!0},todo:{"default":!1},description:{"default":""}},t);var e=this._nodeRepository.getNode(t.id),i=new Node(t);if(null!==e)return void(i.equals(e)||this._eventPubSub.publish("childAddError",[t.parentId,t.id]));var n=this._nodeRepository.getNode(t.parentId);this._nodeRepository.saveNode(i);var s=n.getChildIds();s.push(t.id),this._nodeRepository.saveNode(new Node({id:n.getId(),name:n.getName(),todo:n.getTodo(),description:n.getDescription(),childIds:s})),this._eventPubSub.publish("childAdded",[t.parentId,t.id])},Mapdone.prototype.removeChild=function(t){t=validateArgsObj({parentId:{test:$IsValidUuidV4},childId:{test:$IsValidUuidV4}},t);var e=this._nodeRepository.getNode(t.parentId);-1!==e.getChildIds().indexOf(t.childId)&&(this._nodeRepository.saveNode(new Node({id:e.getId(),name:e.getName(),todo:e.getTodo(),description:e.getDescription(),childIds:e.getChildIds().filter(function(e){return e!=t.childId})})),this._eventPubSub.publish("childRemoved",[t.parentId,t.childId]))},Mapdone.prototype.toggleDone=function(t){t=validateArgsObj({id:{test:$IsValidUuidV4},from:{test:$IsTrueFalseNull}},t);var e,i=this._nodeRepository.getNode(t.id);switch(i.getTodo()){case null:return;case!0:e=!1;break;case!1:e=!0}this._nodeRepository.saveNode(new Node({id:i.getId(),name:i.getName(),todo:e,description:i.getDescription(),childIds:i.getChildIds()})),this._eventPubSub.publish("doneToggled",[t.id,e])},Mapdone.prototype.editNode=function(t){var e=this._nodeRepository.getNode(validateArgsObj({id:{test:$IsValidUuidV4}},t).id),i={name:e.getName(),todo:e.getTodo(),description:e.getDescription()},n={};for(var s in i)if(void 0!==t[s+"To"]&&void 0!==t[s+"From"]){if(t[s+"From"]!==i[s])return;n[s]=t[s+"To"],i[s]=n[s]}i.id=t.id,i.childIds=e.getChildIds(),this._nodeRepository.saveNode(new Node(i)),this._eventPubSub.publish("nodeEdited",[t.id,n])},Mapdone.prototype.reorderChildren=function(t){t=validateArgsObj({id:{test:$IsValidUuidV4},from:{test:$IsArrayOfUuidV4s},to:{test:$IsArrayOfUuidV4s}},t);var e=this._nodeRepository.getNode(t.id),i=e.getChildIds(),n=t.from.join(",");if(n!==t.to.join(",")&&i.join(",")===n&&t.to.length===i.length){for(var s=0;s<i.length;s++)if(-1===t.to.indexOf(i[s]))return;this._nodeRepository.saveNode(new Node({id:t.id,name:e.getName(),todo:e.getTodo(),description:e.getDescription(),childIds:t.to})),this._eventPubSub.publish("childrenReordered",[t.id,t.to])}},InMemoryNodeRepository.prototype.getRootId=function(){return this._rootId},InMemoryNodeRepository.prototype.setRootId=function(t){this._rootId=t},InMemoryNodeRepository.prototype.getNode=function(t){return this._nodes[t]||null},InMemoryNodeRepository.prototype.saveNode=function(t){this._nodes[t.getId()]=t},contractIterate(Mapdone,function(t){CommandHandler.prototype[t]=function(){throw new Error("Not implemented "+t)}}),contractIterate(Mapdone,function(t){CommandExecutor.prototype[t]=function(){try{this._mapdone[t].apply(this._mapdone,arguments)}catch(e){this._eventPubSub.publish("exception",[t,[].slice.call(arguments,0),e])}}}),LocalNodeRepository.prototype.getRootId=function(){return localStorage.getItem("root")},LocalNodeRepository.prototype.setRootId=function(t){localStorage.setItem("root",t)},LocalNodeRepository.prototype.createRoot=function(t){this.saveNode(t),localStorage.setItem("root",t.getId())},LocalNodeRepository.prototype.getNode=function(t){var e=JSON.parse(localStorage.getItem(t));return null===e?null:new Node({id:t,name:e.name,todo:e.todo,description:e.description,childIds:e.childIds})},LocalNodeRepository.prototype.saveNode=function(t){var e={name:t.getName(),todo:t.getTodo(),description:t.getDescription(),childIds:t.getChildIds()};localStorage.setItem(t.getId(),JSON.stringify(e))},assertAdheresToContract(InMemoryNodeRepository,LocalNodeRepository),LocalReadModel.prototype.getRootId=function(){return localStorage.getItem("root")},LocalReadModel.prototype.getNode=function(t){var e=JSON.parse(localStorage.getItem(t));e.id=t,e.children=[];for(var i=0;i<e.childIds.length;i++){var n=JSON.parse(localStorage.getItem(e.childIds[i]));e.children.push({id:e.childIds[i],name:n.name,todo:n.todo,description:n.description,childIds:n.childIds,childCount:n.childIds.length})}return e};var LOCAL_EVENT_PUBSUB=new EventPubSub,LOCAL_READ_MODEL=new LocalReadModel,COMMAND_EXECUTOR=new CommandExecutor(function(){return new Mapdone(LOCAL_EVENT_PUBSUB,new LocalNodeRepository)}.call(),LOCAL_EVENT_PUBSUB),NEW_ROOT,ROOT_ID=function(){var t=LOCAL_READ_MODEL.getRootId();return null!==t?t:(NEW_ROOT={id:uuid.v4(),name:"All of the Things",description:'This is the centre of your "todo" universe - welcome home! Try clicking the + below to add more items. Click on the items for more detail, and to add stuff to them in turn. You can edit/delete this text by clicking on the pencil to the right.',children:[]},COMMAND_EXECUTOR.createRoot({id:NEW_ROOT.id,name:NEW_ROOT.name,description:NEW_ROOT.description}),NEW_ROOT.id)}.call(),mapdoneApp=angular.module("mapdoneApp",["ngRoute","ui.sortable","ui.bootstrap","toastr","mapdoneControllers","mapdoneServices"]);mapdoneApp.config(["$routeProvider",function(t){t.when("/node/:nodePath*",{templateUrl:"partials/node-detail.html",controller:"NodeCtrl"}).otherwise({redirectTo:"/node/"+ROOT_ID})}]);var mapdoneServices=angular.module("mapdoneServices",[]);mapdoneServices.factory("CommandHandler",[function(){return COMMAND_EXECUTOR}]),mapdoneServices.factory("ReadModel",[function(){return LOCAL_READ_MODEL}]),mapdoneServices.factory("EventPubSub",[function(){return LOCAL_EVENT_PUBSUB}]),angular.module("ui.bootstrap.modal").directive("modalWindow",["$timeout",function(t){return{priority:1,link:function(e,i){t(function(){i.find("[autofocus]").focus()})}}}]);var mapdoneControllers=angular.module("mapdoneControllers",[]);mapdoneControllers.controller("ModalNodeCtrl",["$scope","$modalInstance","existingNode",function(t,e,i){t.input={},t.input.node={};for(var n in i)t.input.node[n]=i[n];t.input.node.type=null===t.input.node.todo?"note":"todo",t.ok=function(){t.input.node.todo="todo"===t.input.node.type?i.todo===!0?!0:!1:null,e.close(t.input.node)},t.cancel=function(){e.dismiss("cancel")}}]),mapdoneControllers.controller("NodeCtrl",["$scope","$routeParams","$location","$modal","toastr","ReadModel","CommandHandler","EventPubSub",function(t,e,i,n,s,r,o,a){var l=e.nodePath.replace(/^.*\//,"");t.node=r.getNode(l);var u=e.nodePath.split("/");t.breadcrumbs=[];for(var c="",h=0;h<u.length-1;h++){var d=u[h];c+="/"+u[h],t.breadcrumbs.push({path:c,name:r.getNode(d).name})}nodeConfigCommands(t,n,s,o),nodeConfigEvents(t,s,a,r),t.absoluteNavigate=function(t){i.path("/node"+t)},t.relativeNavigate=function(t){i.path(i.path()+"/"+t.id)},t.sortableOptions={containment:"parent",cursor:"ns-resize",tolerance:"pointer",stop:function(){o.reorderChildren({id:t.node.id,from:t.node.childIds,to:t.node.children.map(function(t){return t.id})})}}}]);