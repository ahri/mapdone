"use strict";function contractIterate(t,e){var i,n=t,o="Object";"function"==typeof t&&(n=t.prototype,o=t.name||"AnonymousFunc");for(i in n)"function"==typeof n[i]&&"_"!==i.substr(0,1)&&e(i,n,n[i]);return o}function assertAdheresToContract(t,e){var i=[];contractIterate(t,function(t){i.push(t)}),contractIterate(e,function(n){if(-1===i.indexOf(n))throw new Error("'"+t.name+"' does not implement method '"+n+"' from contract '"+e.name+"'")})}function $IsDefined(t){return void 0!==t}function $IsBool(t){return t===!0||t===!1}function $IsBoolOrNull(t){return t===!0||t===!1||null===t}function $IsValidName(t){return null!==t.match(/^.../)}function $IsValidUuidV4(t){return null!==t.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i)}function $IsArrayOfUuidV4s(t){var e;for(e=0;e<t.length;e++)if(!$IsValidUuidV4(t[e]))return!1;return!0}function applyRulesToMessage(t,e){var i,n={};for(i in t)if(void 0===t[i].default||void 0!==e[i]){if(t[i].required&&(t[i].test=$IsDefined),t[i].test&&t[i].test(e[i])!==!0){if(void 0!==t[i].default){n[i]=t[i].default;continue}throw new Error("Arg '"+i+"' with value '"+e[i]+"' failed test "+t[i].test)}n[i]=e[i]}else n[i]=t[i].default;return n}function EventPubSub(){this._registrations={}}function Node(t){t=applyRulesToMessage({id:{test:$IsValidUuidV4},name:{test:$IsValidName},done:{test:$IsBoolOrNull,"default":!1},description:{"default":""},childIds:{test:$IsArrayOfUuidV4s,"default":[]}},t),this._id=t.id,this._name=t.name,this._done=t.done,this._description=t.description,this._childIds=t.childIds}function Mapdone(t){t=applyRulesToMessage({eventPubSub:{required:!0},nodeReadModel:{required:!0}},t),assertAdheresToContract(t.eventPubSub,EventPubSub),assertAdheresToContract(t.nodeReadModel,NodeReadModel),this._eventPubSub=t.eventPubSub,this._nodeReadModel=t.nodeReadModel}function NodeReadModel(t){t=applyRulesToMessage({data:{required:!0}},t),this._data=t.data}function NodeWriteModel(t){t=applyRulesToMessage({data:{required:!0},nodeReadModel:{required:!0},eventPubSub:{required:!0}},t),this._data=t.data,this._nodeReadModel=t.nodeReadModel,t.eventPubSub.subscribe("rootCreated",function(t){this._saveNode({node:new Node(t)}),this._setRootId(t)},this),t.eventPubSub.subscribe("childAdded",function(t){var e=new Node(t),i=this._getNode({id:t.parentId});i.addChild(t),this._saveNode({node:e}),this._saveNode({node:i})},this),t.eventPubSub.subscribe("childRemoved",function(t){var e=this._getNode({id:t.parentId});e.removeChild({id:t.childId}),this._saveNode({node:e})},this),t.eventPubSub.subscribe("nodeEdited",function(t){var e=this._getNode(t);this._saveNode({node:e.mutate(t)})},this),t.eventPubSub.subscribe("doneToggled",function(t){var e=this._getNode(t).toObj();e.done=t.to,this._saveNode({node:new Node(e)})},this),t.eventPubSub.subscribe("childrenReordered",function(t){var e=this._getNode(t).toObj();e.childIds=t.to,this._saveNode({node:new Node(e)})},this)}function LocalStorageNodeReadModel(t){t=applyRulesToMessage({},t)}function LocalStorageNodeWriteModel(t){t=applyRulesToMessage({nodeReadModel:{required:!0},eventPubSub:{required:!0}},t),this._nodeReadModel=t.nodeReadModel,t.eventPubSub.subscribe("rootCreated",function(t){this._saveNode({node:new Node(t)}),this._setRootId(t)},this),t.eventPubSub.subscribe("childAdded",function(t){var e=new Node(t),i=this._nodeReadModel.getNode({id:t.parentId});i.addChild(t),this._saveNode({node:e}),this._saveNode({node:i})},this),t.eventPubSub.subscribe("childRemoved",function(t){var e=this._nodeReadModel.getNode({id:t.parentId});e.removeChild({id:t.childId}),this._saveNode({node:e})},this),t.eventPubSub.subscribe("nodeEdited",function(t){var e=this._nodeReadModel.getNode(t);this._saveNode({node:e.mutate(t)})},this),t.eventPubSub.subscribe("doneToggled",function(t){var e=this._nodeReadModel.getNode(t).toObj();e.done=t.to,this._saveNode({node:new Node(e)})},this),t.eventPubSub.subscribe("childrenReordered",function(t){var e=this._nodeReadModel.getNode(t).toObj();e.childIds=t.to,this._saveNode({node:new Node(e)})},this)}function updateScopeNode(t,e,i){var n;for(t.node=e.getNode({id:i}).toObj(),t.node.children=[],n=0;n<t.node.childIds.length;n++)t.node.children.push(e.getNode({id:t.node.childIds[n]}).toObj())}function nodeConfigEvents(t,e,i,n){i.subscribe("exception",function(t){var i="Exception event: "+t.command+'("'+t.args.join('", "')+'") -> '+t.text;e.error(i)}),i.subscribe("childAdded",function(e){e.parentId===t.node.id&&updateScopeNode(t,n,t.node.id)}),i.subscribe("childRemoved",function(e){e.parentId===t.node.id&&updateScopeNode(t,n,t.node.id)}),i.subscribe("nodeEdited",function(e){var i=t.node.childIds;i.push(t.node.id),-1!==i.indexOf(e.id)&&updateScopeNode(t,n,t.node.id)}),i.subscribe("doneToggled",function(e){var i=t.node.childIds;i.push(t.node.id),-1!==i.indexOf(e.id)&&updateScopeNode(t,n,t.node.id)})}function nodeConfigCommands(t,e,i,n){t.newChild=function(t){var i=e.open({templateUrl:"modal-node.html",controller:"ModalNodeCtrl",resolve:{existingNode:function(){return{}}}});i.result.then(function(e){n.addChild({parentId:t.id,id:uuid.v4(),name:e.name,done:e.done,description:e.description})})},t.editNode=function(t){var i=e.open({templateUrl:"modal-node.html",controller:"ModalNodeCtrl",resolve:{existingNode:function(){return t}}});i.result.then(function(e){for(var i={},o=["name","done","description"],s=0;s<o.length;s++){var r=o[s];t[r]!==e[r]&&(i[r+"From"]=t[r],i[r+"To"]=e[r])}i.id=t.id,n.editNode(i)})},t.attachExisting=function(){i.error("Not yet implemented")},t.addChild=function(){n.addChild({parentId:nodeId,id:uuid.v4(),name:t.newChild.name}),t.newChild.name="",t.newChild.show=!1},t.removeChild=function(t,e){n.removeChild({parentId:t.id,childId:e.id})},t.toggleDone=function(t){n.toggleDone({id:t.id,from:t.done})}}EventPubSub.prototype.subscribe=function(t,e,i){void 0===this._registrations[t]&&(this._registrations[t]=[]),this._registrations[t].push({func:e,"this":i})},EventPubSub.prototype.publish=function(t,e){var i;if(void 0!==this._registrations[t])for(i=0;i<this._registrations[t].length;i++)this._registrations[t][i].func.call(this._registrations[t][i]["this"],e)},Node.prototype.toString=function(){return"Node<"+this._id.substring(0,6)+":"+this._name+">"},Node.prototype.toObj=function(){return{id:this._id,name:this._name,done:this._done,description:this._description,childIds:this._childIds.slice(0)}},Node.prototype.getId=function(){return this._id},Node.prototype.getName=function(){return this._name},Node.prototype.getDone=function(){return this._done},Node.prototype.getDescription=function(){return this._description},Node.prototype.getChildIds=function(){return this._childIds},Node.prototype.equals=function(t){return this.getId()===t.getId()&&this.getName()===t.getName()&&this.getDone()===t.getDone()&&this.getDescription()===t.getDescription()&&this.getChildIds().join(",")===t.getChildIds().join(",")},Node.prototype.addChild=function(t){if(t=applyRulesToMessage({id:{required:!0}},t),-1!==this._childIds.indexOf(t.id))throw new Error("Child "+t.id+" cannot be re-added");this._childIds.push(t.id)},Node.prototype.removeChild=function(t){if(t=applyRulesToMessage({id:{required:!0}},t),-1===this._childIds.indexOf(t.id))throw new Error("Child "+t.id+" cannot be removed as it is not a known child");this._childIds=this._childIds.filter(function(e){return e!==t.id})},Node.prototype.toggleDone=function(){switch(this._done){case!0:this._done=!1;break;case!1:this._done=!0;break;default:throw new Error("Can't toggle from done state: "+this._done)}},Node.prototype.mutate=function(t){return t=applyRulesToMessage({name:{"default":this._name},done:{"default":this._done},description:{"default":this._description}},t),t.id=this._id,t.childIds=this._childIds.slice(0),new Node(t)},Node.prototype.reorderChildren=function(t){var e,i;if(t=applyRulesToMessage({to:{test:$IsArrayOfUuidV4s}},t),t.to.length!==this._childIds.length)throw new Error("The 'to' array length does not match the current state");for(i=this._childIds.slice(0),e=0;e<i.length;e++){if(-1===t.to.indexOf(i[e]))throw new Error("The 'to' array doesn't contain all of the items in the current state");this.removeChild({id:i[e]})}for(e=0;e<t.to;e++)this.addChild({id:t.to[e]})},Mapdone.prototype._getNode=function(t){var e=this._nodeReadModel.getNode(t);return assertAdheresToContract(Node,e),e},Mapdone.prototype.createRoot=function(t){if(t=applyRulesToMessage({id:{test:$IsValidUuidV4},name:{required:!0},done:{"default":null},description:{"default":""}},t),this._nodeReadModel.rootIsSet())throw new Error("The root id "+this._nodeReadModel.getRootId()+" cannot be overriden by id "+t.id);this._eventPubSub.publish("rootCreated",t)},Mapdone.prototype.addChild=function(t){var e,i,n;if(t=applyRulesToMessage({parentId:{test:$IsValidUuidV4},id:{test:$IsValidUuidV4},name:{required:!0},done:{"default":!1},description:{"default":""}},t),e=new Node(t),this._nodeReadModel.nodeExists(t))throw new Error("Cannot replace existing child "+t.id);i=this._getNode({id:t.parentId}),i.addChild({id:e.getId()}),n=e.toObj(),n.parentId=i.getId(),this._eventPubSub.publish("childAdded",n)},Mapdone.prototype.removeChild=function(t){var e;t=applyRulesToMessage({parentId:{test:$IsValidUuidV4},childId:{test:$IsValidUuidV4}},t),e=this._getNode({id:t.parentId}),e.removeChild({id:t.childId}),this._eventPubSub.publish("childRemoved",t)},Mapdone.prototype.toggleDone=function(t){var e,i;t=applyRulesToMessage({id:{test:$IsValidUuidV4},from:{test:$IsBool}},t),e=this._getNode(t),e.toggleDone(),i=t,i.to=e.getDone(),this._eventPubSub.publish("doneToggled",i)},Mapdone.prototype.editNode=function(t){var e,i,n,o;i=this._getNode(applyRulesToMessage({id:{test:$IsValidUuidV4}},t)),n={name:i.getName(),done:i.getDone(),description:i.getDescription()},o={};for(e in n)if(void 0!==t[e+"To"]&&void 0!==t[e+"From"]){if(t[e+"From"]!==n[e])throw new Error("Mismatch on field '"+e+"'");o[e]=t[e+"To"]}i.mutate(o),o.id=t.id,this._eventPubSub.publish("nodeEdited",o)},Mapdone.prototype.reorderChildren=function(t){var e,i;if(t=applyRulesToMessage({id:{test:$IsValidUuidV4},from:{test:$IsArrayOfUuidV4s},to:{test:$IsArrayOfUuidV4s}},t),e=this._getNode(t),i=t.from.join(","),i===t.to.join(","))throw new Error("No point in reordering if nothing changed");if(e.getChildIds().join(",")!==i)throw new Error("The 'from' does not match the current state");e.reorderChildren({to:t.to}),this._eventPubSub.publish("childrenReordered",{id:t.id,to:t.to})},NodeReadModel.prototype.rootIsSet=function(){return void 0!==this._data.root},NodeReadModel.prototype.getRootId=function(){if(!this.rootIsSet())throw new Error("Root is not yet defined");return this._data.root},NodeReadModel.prototype.nodeExists=function(t){return t=applyRulesToMessage({id:{required:!0}},t),void 0!==this._data[t.id]},NodeReadModel.prototype.getNode=function(t){var e;if(t=applyRulesToMessage({id:{required:!0}},t),e=this._data[t.id],void 0===e)throw new Error("Node "+t.id+" does not exist");return new Node(e.toObj())},NodeWriteModel.prototype._getNode=function(t){var e=this._nodeReadModel.getNode(t);return assertAdheresToContract(Node,e),e},NodeWriteModel.prototype._setRootId=function(t){t=applyRulesToMessage({id:{required:!0}},t),this._data.root=t.id},NodeWriteModel.prototype._saveNode=function(t){t=applyRulesToMessage({node:{required:!0}},t),this._data[t.node.getId()]=t.node},LocalStorageNodeReadModel.prototype._prefix=function(t){return"node-"+t},LocalStorageNodeReadModel.prototype.rootIsSet=function(){return null!==localStorage.getItem(this._prefix("root"))},LocalStorageNodeReadModel.prototype.getRootId=function(){if(!this.rootIsSet())throw new Error("Root is not yet defined");return localStorage.getItem(this._prefix("root"))},LocalStorageNodeReadModel.prototype.nodeExists=function(t){return t=applyRulesToMessage({id:{required:!0}},t),null!==localStorage.getItem(this._prefix(t.id))},LocalStorageNodeReadModel.prototype._getNode=function(t){var e;if(t=applyRulesToMessage({id:{required:!0}},t),e=localStorage.getItem(this._prefix(t.id)),null===e)throw new Error("Node "+t.id+" does not exist");return e=JSON.parse(e),e.id=t.id,new Node(e)},LocalStorageNodeReadModel.prototype.getNode=function(t){var e,i,n,o=this._getNode(t);for(o.id=o.getId(),o.name=o.getName(),o.done=o.getDone(),o.description=o.getDescription(),o.children=[],i=o.getChildIds(),e=0;e<i.length;e++)n=this._getNode({id:i[e]}),n.id=n.getId(),n.name=n.getName(),n.done=n.getDone(),n.description=n.getDescription(),o.children.push(n);return o},LocalStorageNodeWriteModel.prototype._prefix=function(t){return"node-"+t},LocalStorageNodeWriteModel.prototype._setRootId=function(t){t=applyRulesToMessage({id:{required:!0}},t),localStorage.setItem(this._prefix("root"),t.id)},LocalStorageNodeWriteModel.prototype._saveNode=function(t){t=applyRulesToMessage({node:{required:!0}},t),localStorage.setItem(this._prefix(t.node.getId()),JSON.stringify({name:t.node.getName(),done:t.node.getDone(),description:t.node.getDescription(),childIds:t.node.getChildIds()}))},assertAdheresToContract(NodeReadModel,LocalStorageNodeReadModel);var LOCAL_EVENT_PUBSUB=new EventPubSub,LOCAL_READ_MODEL=new LocalStorageNodeReadModel,LOCAL_WRITE_MODEL=new LocalStorageNodeWriteModel({nodeReadModel:LOCAL_READ_MODEL,eventPubSub:LOCAL_EVENT_PUBSUB}),COMMAND_EXECUTOR=new Mapdone({eventPubSub:LOCAL_EVENT_PUBSUB,nodeReadModel:LOCAL_READ_MODEL}),NEW_ROOT,ROOT_ID=function(){return LOCAL_READ_MODEL.rootIsSet()?LOCAL_READ_MODEL.getRootId():(NEW_ROOT={id:uuid.v4(),name:"All of the Things",description:'This is the centre of your "todo" universe - welcome home! Try clicking the + below to add more items. Click on the items for more detail, and to add stuff to them in turn. You can edit/delete this text by clicking on the pencil to the right.',children:[]},COMMAND_EXECUTOR.createRoot({id:NEW_ROOT.id,name:NEW_ROOT.name,description:NEW_ROOT.description}),NEW_ROOT.id)}.call(),mapdoneApp=angular.module("mapdoneApp",["ngRoute","ui.sortable","ui.bootstrap","toastr","monospaced.elastic","mapdoneControllers","mapdoneServices"]);mapdoneApp.config(["$routeProvider",function(t){t.when("/node/:nodePath*",{templateUrl:"partials/node-detail.html",controller:"NodeCtrl"}).otherwise({redirectTo:"/node/"+ROOT_ID})}]);var mapdoneServices=angular.module("mapdoneServices",[]);mapdoneServices.factory("CommandHandler",[function(){return COMMAND_EXECUTOR}]),mapdoneServices.factory("ReadModel",[function(){return LOCAL_READ_MODEL}]),mapdoneServices.factory("EventPubSub",[function(){return LOCAL_EVENT_PUBSUB}]),angular.module("ui.bootstrap.modal").directive("modalWindow",["$timeout",function(t){return{priority:1,link:function(e,i){t(function(){i.find("[autofocus]").focus()})}}}]);var mapdoneControllers=angular.module("mapdoneControllers",[]);mapdoneControllers.controller("ModalNodeCtrl",["$scope","$modalInstance","existingNode",function(t,e,i){t.input={},t.input.node={};for(var n in i)t.input.node[n]=i[n];t.input.node.type=null===t.input.node.done?"note":"todo",t.ok=function(){t.input.node.done="todo"===t.input.node.type?i.done===!0?!0:!1:null,e.close(t.input.node)},t.cancel=function(){e.dismiss("cancel")}}]),mapdoneControllers.controller("NodeCtrl",["$scope","$routeParams","$location","$modal","toastr","ReadModel","CommandHandler","EventPubSub",function(t,e,i,n,o,s,r,a){var l=e.nodePath.replace(/^.*\//,"");updateScopeNode(t,s,l);var u=e.nodePath.split("/");t.breadcrumbs=[];for(var c="",h=0;h<u.length-1;h++){var d=u[h];c+="/"+u[h],t.breadcrumbs.push({path:c,name:s.getNode({id:d}).getName()})}nodeConfigCommands(t,n,o,r),nodeConfigEvents(t,o,a,s),t.absoluteNavigate=function(t){i.path("/node"+t)},t.relativeNavigate=function(t){i.path(i.path()+"/"+t.id)},t.sortableOptions={containment:"parent",cursor:"ns-resize",tolerance:"pointer",stop:function(){r.reorderChildren({id:t.node.id,from:t.node.childIds,to:t.node.children.map(function(t){return t.id})})}}}]);